<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Triage Dashboard</title>
    <style>
        :root {
            --primary-color: #005EB8; /* NHS Blue */
            --secondary-color: #4c6272;
            --background-color: #f0f4f5;
            --card-background: #ffffff;
            --text-color: #212b32;
            --border-color: #d8dde0;
            --red: #d5281b;
            --orange: #ed872d;
            --yellow: #ffb81c;
            --green: #00a499;
            --blue: #005EB8;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-background);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-bottom: 4px solid var(--primary-color);
        }
        
        #logo-container {
            display: flex;
            align-items: center;
        }

        #logo {
            height: 50px;
            margin-right: 15px;
        }

        header h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.8em;
            text-align: left;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .card h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Span multiple columns */
        .card.full-width { grid-column: 1 / -1; }
        .card.span-2 { grid-column: span 2; }
        @media (max-width: 800px) {
            .card.span-2 { grid-column: 1 / -1; }
        }


        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .label-with-checkbox { display: flex; justify-content: space-between; align-items: center; }
        .side-checkbox { display: flex; align-items: center; font-weight: normal; font-size: 14px; }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #f8f9fa;
        }
        textarea { resize: vertical; }
        textarea:disabled { background-color: #e9ecef; cursor: not-allowed; }

        .input-group { display: flex; align-items: center; }
        .input-group input { flex: 1; }
        .input-group span { margin-left: 10px; color: var(--secondary-color); }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { width: 20px; height: 20px; }

        /* Discriminator styles */
        #discriminators-container .discriminator {
            padding: 10px; margin-bottom: 8px; border-radius: 4px; cursor: pointer;
            border-left-width: 5px; border-left-style: solid; transition: all 0.2s;
        }
        .discriminator.highlight { border: 2px solid var(--primary-color); font-weight: bold; }
        .priority-Red { border-left-color: var(--red); background-color: #ffebee; }
        .priority-Orange { border-left-color: var(--orange); background-color: #fff3e0; }
        .priority-Yellow { border-left-color: var(--yellow); background-color: #fffde7; }
        .priority-Green { border-left-color: var(--green); background-color: #e0f2f1; }
        .priority-Blue { border-left-color: var(--blue); background-color: #e3f2fd; }

        /* Critical Alert Banner */
        #critical-alert-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--red);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 1000;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(213, 40, 27, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(213, 40, 27, 0); }
            100% { box-shadow: 0 0 0 0 rgba(213, 40, 27, 0); }
        }

        /* Visual EWS Chart */
        #visual-ews-container { margin-top: 20px; }
        .ews-row { display: flex; margin-bottom: 5px; align-items: center; }
        .ews-label { width: 100px; font-weight: bold; font-size: 0.9em; }
        .ews-track { flex-grow: 1; display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .ews-box {
            text-align: center; padding: 5px; font-size: 0.8em;
            background-color: #f8f9fa; border-right: 1px solid #eee;
        }
        .ews-box:last-child { border-right: none; }
        .ews-box.score-3 { background-color: var(--red); color: white; }
        .ews-box.score-2 { background-color: var(--orange); color: white; }
        .ews-box.score-1 { background-color: var(--yellow); }
        .ews-box.score-0 { background-color: var(--green); color: white; }
        .ews-box.active-score { border: 2px solid black; font-weight: bold; transform: scale(1.1); z-index: 10; }

        /* Timer and Alerts Card */
        .timer { font-size: 2em; font-weight: bold; color: var(--red); text-align: center; }
        .timer-label { text-align: center; display: block; margin-top: -10px; }
        #alerts-list li { color: var(--red); font-weight: bold; }

        /* Summary and Actions */
        #summary-priority-display { text-align: center; padding: 15px; font-size: 1.5em; font-weight: bold; color: white; border-radius: 8px; }
        .summary-priority-Red { background-color: var(--red); } .summary-priority-Orange { background-color: var(--orange); }
        .summary-priority-Yellow { background-color: var(--yellow); color: var(--text-color); }
        .summary-priority-Green { background-color: var(--green); } .summary-priority-Blue { background-color: var(--blue); }
        
        #actions-list { list-style-type: none; padding-left: 0; }
        #actions-list li { display: flex; align-items: center; margin-bottom: 8px; }
        #actions-list input[type="checkbox"] { margin-right: 10px; }
        #actions-list a { color: var(--primary-color); text-decoration: none; margin-left: 5px;}
        #actions-list a:hover { text-decoration: underline; }

        /* Decision Support */
        .decision-support-section h3 { font-size: 1em; margin-top: 15px; color: var(--secondary-color); }
        .decision-support-recommendation { padding: 10px; border-radius: 4px; font-weight: bold; text-align: center; margin-top: 10px; }
        .recommend-yes { background-color: #ffebee; border-left: 4px solid var(--red); }
        .recommend-no { background-color: #e0f2f1; border-left: 4px solid var(--green); }

        /* Paediatric Dosing */
        #paediatric-dosing-results { background-color: #e3f2fd; padding: 15px; border-radius: 4px; margin-top: 10px; }
        #paediatric-dosing-results p { margin: 5px 0; }
        #paediatric-dosing-results strong { color: var(--primary-color); }

        .btn-group { display: flex; justify-content: flex-end; gap: 10px; }
        button { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #003087; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #334451; }

        footer { text-align: center; margin-top: 20px; font-size: 12px; color: #6c757d; }
    </style>
</head>
<body>

    <div id="critical-alert-banner"></div>

    <div class="container">
        <header>
             <div id="logo-container">
                <img id="logo" src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo">
                <h1>Advanced Triage Dashboard</h1>
            </div>
            <div class="btn-group">
                <button id="btn-reset">Start New Triage</button>
            </div>
        </header>

        <div class="dashboard">

            <!-- DEMOGRAPHICS & HISTORY -->
            <div class="card span-2">
                <h2>Patient Demographics & History</h2>
                <div class="dashboard" style="gap: 15px;">
                    <div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="patient-referral"><label for="patient-referral">Patient is a GP or Specialty Referral</label>
                        </div>
                        <div class="form-group"><label for="patient-id">Patient Name / ID</label><input type="text" id="patient-id" placeholder="e.g., John Doe"></div>
                        <div class="form-group"><label for="patient-age">Age</label><div class="input-group"><input type="number" id="patient-age" min="0"><span>years</span></div></div>
                        <div class="form-group"><label for="patient-weight">Weight</label><div class="input-group"><input type="number" id="patient-weight" min="0"><span>kg</span></div></div>
                        <div class="form-group"><label for="patient-sex">Sex</label><select id="patient-sex"><option value="">-- Select --</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
                        <div class="form-group" id="other-sex-container" style="display: none;"><label for="other-sex-text">Please specify:</label><input type="text" id="other-sex-text"></div>
                        <div class="form-group checkbox-group"><input type="checkbox" id="patient-pregnant"><label for="patient-pregnant">Patient is pregnant or <6w postpartum</label></div>
                    </div>
                    <div>
                        <div class="form-group">
                            <div class="label-with-checkbox"><label for="allergies">Allergies</label><div class="side-checkbox"><input type="checkbox" id="allergies-nkda"><label for="allergies-nkda" style="margin-left: 5px; font-weight: normal;">NKDA</label></div></div>
                            <textarea id="allergies" rows="2" placeholder="e.g., Penicillin..."></textarea>
                        </div>
                        <div class="form-group">
                            <div class="label-with-checkbox"><label for="pmh">Past Medical History</label><div class="side-checkbox"><input type="checkbox" id="pmh-nil"><label for="pmh-nil" style="margin-left: 5px; font-weight: normal;">Nil known</label></div></div>
                            <textarea id="pmh" rows="3" placeholder="e.g., IHD, Asthma..."></textarea>
                        </div>
                        <div class="form-group">
                            <div class="label-with-checkbox"><label for="meds">Prescribed Medications</label><div class="side-checkbox"><input type="checkbox" id="meds-nil"><label for="meds-nil" style="margin-left: 5px; font-weight: normal;">Nil known</label></div></div>
                            <textarea id="meds" rows="3" placeholder="e.g., Aspirin, Anticoagulants..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PRESENTING COMPLAINT -->
            <div class="card span-2">
                <h2>Presenting Complaint (MTS)</h2>
                <div class="dashboard">
                    <div id="complaint-section">
                        <div class="form-group">
                            <label for="mts-flowchart">Primary Complaint:</label>
                            <select id="mts-flowchart"><option value="">-- Select a flowchart --</option></select>
                        </div>
                        <div class="form-group"><label for="complaint-info">History of Presenting Complaint:</label><textarea id="complaint-info" rows="4" placeholder="e.g., Took 16 paracetamol tablets 2 hours ago..."></textarea></div>
                        <div id="context-questions-container"></div>
                    </div>
                    <div id="discriminator-section">
                        <label>Select Highest Priority Discriminator:</label>
                        <div id="discriminators-container" style="max-height: 250px; overflow-y: auto; padding-right: 10px;">
                            <p>Select a complaint first.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OBSERVATIONS & EWS -->
            <div class="card span-2">
                <h2 id="obs-title">Physiological Observations</h2>
                <div class="dashboard">
                    <div id="obs-form-container">
                        <p>Enter patient age to see observation fields.</p>
                    </div>
                    <div id="ews-display-container" style="display: none;">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0;">Total Score:</h3>
                            <span id="total-ews-score" style="font-size: 2.5em; font-weight: bold; color: var(--primary-color);">0</span>
                        </div>
                        <div id="visual-ews-container"></div>
                    </div>
                </div>
            </div>

            <!-- PAEDIATRIC DOSING -->
            <div id="paediatric-dosing-card" class="card" style="display: none;">
                <h2>Paediatric Dosing</h2>
                <p>Calculations based on a weight of <strong id="dosing-weight">N/A kg</strong>. Always double-check calculations.</p>
                <div id="paediatric-dosing-results"></div>
            </div>
            
            <!-- DECISION SUPPORT -->
            <div id="decision-support-card" class="card" style="display: none;">
                <h2>Clinical Decision Support</h2>
                <div id="decision-support-content"></div>
            </div>
            
            <!-- ALERTS & TIMERS -->
            <div class="card">
                <h2>Live Alerts & Timers</h2>
                <ul id="alerts-list"></ul>
                <div id="timers-container"></div>
            </div>

            <!-- SCORES & DIFFERENTIALS -->
            <div class="card">
                <h2>Calculated Scores & Differentials</h2>
                <ul id="scores-list"><li>No scores calculated.</li></ul>
                <hr>
                <label>Potential Differential Diagnoses:</label>
                <ul id="diff-diag-list"><li>Select a primary complaint to generate.</li></ul>
            </div>
            
            <!-- ACTION PLAN -->
            <div class="card">
                <h2>Action Plan from Triage</h2>
                <div id="summary-priority-display">Awaiting Triage Category</div>
                 <div class="form-group checkbox-group" style="margin-top: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                    <input type="checkbox" id="tick-all-actions"><label for="tick-all-actions">Tick All</label>
                </div>
                <ul id="actions-list"><li>Awaiting triage completion.</li></ul>
            </div>
            
            <!-- CLINICIAN OVERRIDE -->
            <div class="card">
                <h2>Clinician Override</h2>
                <div class="form-group">
                    <label for="override-category">Override Triage Category</label>
                    <select id="override-category">
                        <option value="">-- No Override --</option>
                        <option value="Red">1 - Red</option>
                        <option value="Orange">2 - Orange</option>
                        <option value="Yellow">3 - Yellow</option>
                        <option value="Green">4 - Green</option>
                        <option value="Blue">5 - Blue</option>
                    </select>
                </div>
                <div class="form-group" id="override-reason-container" style="display: none;">
                    <label for="override-reason">Reason for Override</label>
                    <textarea id="override-reason" rows="3" placeholder="e.g., Patient appears more unwell than score suggests..."></textarea>
                </div>
            </div>


            <!-- HANDOVER & NOTES -->
            <div class="card full-width">
                <h2>Notes & Handover</h2>
                <div class="dashboard">
                    <div>
                        <label for="epr-note">Triage Note (for EPR)</label>
                        <textarea id="epr-note" rows="10" readonly></textarea>
                        <button id="btn-copy-note" type="button" style="margin-top: 10px;">Copy EPR Note</button>
                    </div>
                    <div>
                        <label for="sbar-note">SBAR Handover Note</label>
                        <textarea id="sbar-note" rows="10" readonly></textarea>
                        <button id="btn-copy-sbar" type="button" style="margin-top: 10px;">Copy SBAR Note</button>
                    </div>
                </div>
            </div>

        </div>
        <footer>
            <p>This is a demonstration application for illustrative purposes only and must not be used for actual clinical decision-making. The user confirms they have the appropriate license to use the Manchester Triage System.</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA & CONFIGURATION ---
        const mtsFlowcharts = {
            "Abdominal Pain": [{"text":"Catastrophic haemorrhage","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Peritonism","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Testicular torsion","priority":"Orange"},{"text":"Significant history","priority":"Yellow"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Vomiting blood","priority":"Yellow"},{"text":"Altered GCS","priority":"Yellow"},{"text":"Haemodynamic instability","priority":"Yellow"},{"text":"New onset in elderly","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Vomiting","priority":"Green"},{"text":"Urinary symptoms","priority":"Green"},{"text":"Recent problem","priority":"Blue"},{"text":"Old problem","priority":"Blue"}],
            "Abdominal Pain in Children": [{"text":"Unresponsive","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Peritonism","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Testicular torsion","priority":"Orange"},{"text":"Bile-stained vomit","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Vomiting blood","priority":"Yellow"},{"text":"Dehydration","priority":"Yellow"},{"text":"Abdominal distension","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Vomiting","priority":"Green"},{"text":"Recent problem","priority":"Blue"}],
            "Allergies": [{"text":"Airway compromise","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Stridor","priority":"Orange"},{"text":"Wheeze","priority":"Orange"},{"text":"Oedema of tongue/throat","priority":"Orange"},{"text":"Widespread rash","priority":"Yellow"},{"text":"Facial oedema","priority":"Yellow"},{"text":"History of severe reaction","priority":"Yellow"},{"text":"Localised rash","priority":"Green"},{"text":"Itch","priority":"Green"}],
            "Assault": [{"text":"Airway compromise","priority":"Red"},{"text":"Catastrophic haemorrhage","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Altered GCS","priority":"Orange"},{"text":"Penetrating injury to head, neck, torso","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Large haematoma","priority":"Yellow"},{"text":"History of LOC","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Small laceration","priority":"Green"},{"text":"Recent problem","priority":"Blue"}],
            "Back Pain": [{"text":"Catastrophic haemorrhage","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"New extensive neurological deficit","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"New focal neurological deficit","priority":"Yellow"},{"text":"Cauda equina syndrome symptoms","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Mechanical back pain","priority":"Green"},{"text":"Old problem","priority":"Blue"}],
            "Breathing Problems": [{"text":"Apnoeic","priority":"Red"},{"text":"Severe respiratory distress","priority":"Orange"},{"text":"Shock","priority":"Orange"},{"text":"Stridor","priority":"Orange"},{"text":"New confusion","priority":"Orange"},{"text":"Moderate respiratory distress","priority":"Yellow"},{"text":"Haemoptysis","priority":"Yellow"},{"text":"Abnormal vital signs","priority":"Yellow"},{"text":"Mild respiratory distress","priority":"Green"},{"text":"Cough","priority":"Green"},{"text":"Sore throat","priority":"Green"}],
            "Burns and Scalds": [{"text":"Major burn (>15% adult, >10% child)","priority":"Red"},{"text":"Airway compromise","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Inhalational injury","priority":"Orange"},{"text":"Circumferential burn","priority":"Orange"},{"text":"Chemical/electrical burn","priority":"Orange"},{"text":"Moderate burn (5-15% adult, 5-10% child)","priority":"Yellow"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Burn to face, hands, feet, perineum","priority":"Yellow"},{"text":"Minor burn (<5%)","priority":"Green"},{"text":"Mild pain","priority":"Green"},{"text":"Sunburn","priority":"Blue"}],
            "Chest Pain": [{"text":"Airway compromise","priority":"Red"},{"text":"Catastrophic haemorrhage","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Severe respiratory distress","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"New confusion","priority":"Orange"},{"text":"Cardiac-type chest pain at rest","priority":"Yellow"},{"text":"Pleuritic chest pain","priority":"Yellow"},{"text":"Abnormal vital signs","priority":"Yellow"},{"text":"Haemoptysis","priority":"Yellow"},{"text":"Recent non-cardiac pain","priority":"Green"},{"text":"Musculoskeletal pain","priority":"Green"}],
            "Collapse": [{"text":"Unresponsive","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"New GCS < 15","priority":"Orange"},{"text":"Seizing now","priority":"Orange"},{"text":"Significant injury","priority":"Orange"},{"text":"Post-ictal","priority":"Yellow"},{"text":"Abnormal vital signs","priority":"Yellow"},{"text":"Cardiac history","priority":"Yellow"},{"text":"Simple faint, now recovered","priority":"Green"},{"text":"Normal vital signs","priority":"Green"}],
            "Crying Baby": [{"text":"Unresponsive","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Seizing now","priority":"Orange"},{"text":"Non-blanching rash","priority":"Orange"},{"text":"High-pitched/inconsolable cry","priority":"Orange"},{"text":"Grunting/severe respiratory distress","priority":"Orange"},{"text":"Looks unwell","priority":"Yellow"},{"text":"Dehydration","priority":"Yellow"},{"text":"Fever","priority":"Yellow"},{"text":"Parental concern","priority":"Yellow"},{"text":"Seems well","priority":"Green"}],
            "Dental Problems": [{"text":"Airway compromise","priority":"Red"},{"text":"Uncontrolled bleeding","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Facial swelling with systemic signs","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Facial swelling","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Lost filling","priority":"Blue"}],
            "Diarrhoea and Vomiting": [{"text":"Shock","priority":"Red"},{"text":"Severe dehydration","priority":"Orange"},{"text":"Altered GCS","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Moderate dehydration","priority":"Yellow"},{"text":"Vomiting blood","priority":"Yellow"},{"text":"High fever","priority":"Yellow"},{"text":"Mild dehydration","priority":"Green"},{"text":"Vomiting","priority":"Green"},{"text":"Diarrhoea","priority":"Green"}],
            "Ear Problems": [{"text":"Severe pain","priority":"Orange"},{"text":"Sudden onset deafness","priority":"Orange"},{"text":"Mastoid tenderness","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Discharge","priority":"Yellow"},{"text":"Foreign body","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Wax","priority":"Blue"}],
            "Eye Problems": [{"text":"Sudden loss of vision","priority":"Red"},{"text":"Chemical eye injury","priority":"Red"},{"text":"Penetrating eye injury","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Reduced visual acuity","priority":"Yellow"},{"text":"Foreign body sensation","priority":"Yellow"},{"text":"Painful red eye","priority":"Yellow"},{"text":"Flash burns","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Conjunctivitis","priority":"Green"}],
            "Falls": [{"text":"Major trauma","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Altered GCS","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Long lie (>1 hour)","priority":"Orange"},{"text":"Suspected neck of femur fracture","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"History of LOC","priority":"Yellow"},{"text":"Inability to weight bear","priority":"Yellow"},{"text":"Head injury with anticoagulants","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Able to weight bear","priority":"Green"}],
            "Fits": [{"text":"Seizing now","priority":"Red"},{"text":"Post-ictal, not recovering","priority":"Orange"},{"text":"New focal neurology","priority":"Orange"},{"text":"Suspected head injury","priority":"Orange"},{"text":"Post-ictal, recovering","priority":"Yellow"},{"text":"First fit","priority":"Yellow"},{"text":"Fever","priority":"Yellow"},{"text":"Known epileptic, recovered","priority":"Green"}],
            "Head Injury": [{"text":"GCS < 9","priority":"Red"},{"text":"GCS 9-12","priority":"Orange"},{"text":"Penetrating injury","priority":"Orange"},{"text":"Seizing now","priority":"Orange"},{"text":"Focal neurological deficit","priority":"Orange"},{"text":"GCS 13-14","priority":"Yellow"},{"text":"Vomiting >1 episode","priority":"Yellow"},{"text":"History of LOC >5 mins","priority":"Yellow"},{"text":"Amnesia","priority":"Yellow"},{"text":"On anticoagulants","priority":"Yellow"},{"text":"GCS 15, no other factors","priority":"Green"}],
            "Headache": [{"text":"Reduced level of consciousness (GCS < 13)","priority":"Red"},{"text":"Sudden onset severe headache ('thunderclap')","priority":"Orange"},{"text":"New neurological deficit","priority":"Orange"},{"text":"Meningism (fever, neck stiffness, photophobia)","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"New onset headache >50 years","priority":"Yellow"},{"text":"Headache with visual disturbance","priority":"Yellow"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Chronic headache, unchanged","priority":"Blue"}],
            "Limb Problem (Injury)": [{"text":"Major trauma","priority":"Red"},{"text":"Catastrophic haemorrhage","priority":"Red"},{"text":"Neurovascular compromise","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Obvious deformity/dislocation","priority":"Orange"},{"text":"Suspected neck of femur fracture","priority":"Orange"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Inability to weight bear","priority":"Yellow"},{"text":"Large wound","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Able to weight bear","priority":"Green"},{"text":"Minor injury","priority":"Blue"}],
            "Limb Problem (Non-Injury)": [{"text":"Neurovascular compromise","priority":"Red"},{"text":"Severe pain","priority":"Orange"},{"text":"Hot, swollen, tender joint","priority":"Orange"},{"text":"Suspected DVT","priority":"Yellow"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Cellulitis","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Chronic pain","priority":"Blue"}],
            "Mental Health Problem": [{"text":"Immediate risk to self or others","priority":"Red"},{"text":"Violent or aggressive","priority":"Red"},{"text":"Severe distress or agitation","priority":"Orange"},{"text":"Acute psychosis","priority":"Orange"},{"text":"Overdose (conscious)","priority":"Orange"},{"text":"Suicidal ideation with plan","priority":"Yellow"},{"text":"Distressed","priority":"Yellow"},{"text":"Self-harm (minor)","priority":"Yellow"},{"text":"Low mood, no immediate risk","priority":"Green"},{"text":"Request for medication","priority":"Blue"}],
            "Overdose and Poisoning": [{"text":"Unresponsive","priority":"Red"},{"text":"Seizing now","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Altered GCS","priority":"Orange"},{"text":"Abnormal vital signs","priority":"Orange"},{"text":"High-risk substance (e.g., TCA, Paracetamol > guideline)","priority":"Orange"},{"text":"Deliberate self-harm intent","priority":"Yellow"},{"text":"Symptomatic but stable","priority":"Yellow"},{"text":"Asymptomatic, low-risk substance","priority":"Green"},{"text":"Information request","priority":"Blue"}],
            "Pregnancy": [{"text":"Imminent delivery","priority":"Red"},{"text":"Catastrophic haemorrhage","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Heavy vaginal bleeding","priority":"Orange"},{"text":"Seizing (eclampsia)","priority":"Orange"},{"text":"Reduced fetal movements","priority":"Yellow"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Minor vaginal bleeding","priority":"Yellow"},{"text":"Ruptured membranes","priority":"Yellow"},{"text":"Mild pain","priority":"Green"},{"text":"Vomiting","priority":"Green"}],
            "Rash": [{"text":"Shock","priority":"Red"},{"text":"Non-blanching rash with fever/lethargy","priority":"Orange"},{"text":"Stridor or wheeze","priority":"Orange"},{"text":"Widespread, blistering rash","priority":"Orange"},{"text":"Non-blanching rash, patient well","priority":"Yellow"},{"text":"Widespread rash with fever","priority":"Yellow"},{"text":"Localised blistering rash","priority":"Yellow"},{"text":"Itchy rash","priority":"Green"},{"text":"Localised rash, patient well","priority":"Green"}],
            "Shortness of Breath in Children": [{"text":"Apnoeic or exhausted","priority":"Red"},{"text":"Severe respiratory distress (e.g., grunting, marked recession, cyanosis)","priority":"Orange"},{"text":"Stridor at rest","priority":"Orange"},{"text":"Altered level of consciousness","priority":"Orange"},{"text":"Moderate respiratory distress (e.g., some recession, nasal flaring)","priority":"Yellow"},{"text":"Audible wheeze","priority":"Yellow"},{"text":"History of apnoea","priority":"Yellow"},{"text":"Mild increased work of breathing","priority":"Green"},{"text":"Cough/coryza, no distress","priority":"Green"}],
            "Unwell Adult": [{"text":"Unresponsive or airway compromise","priority":"Red"},{"text":"Shock","priority":"Orange"},{"text":"New GCS < 15","priority":"Orange"},{"text":"High risk of sepsis (meets criteria)","priority":"Orange"},{"text":"Severe pain","priority":"Orange"},{"text":"Looks very unwell","priority":"Yellow"},{"text":"Abnormal vital signs","priority":"Yellow"},{"text":"Significant history","priority":"Yellow"},{"text":"Looks well, normal vital signs","priority":"Green"},{"text":"Symptom enquiry only","priority":"Blue"}],
            "Urinary Problems": [{"text":"Shock (septic)","priority":"Red"},{"text":"Severe pain (renal colic/retention)","priority":"Orange"},{"text":"Systemically unwell with fever","priority":"Orange"},{"text":"Acute urinary retention","priority":"Yellow"},{"text":"Visible haematuria","priority":"Yellow"},{"text":"Moderate pain","priority":"Yellow"},{"text":"Symptoms of UTI","priority":"Green"},{"text":"Catheter problem","priority":"Green"}],
            "Worried Parent": [{"text":"Parent states 'child is dying'","priority":"Red"},{"text":"Parent states 'child is very ill'","priority":"Orange"},{"text":"Parent states 'child is ill'","priority":"Yellow"},{"text":"Parent is worried","priority":"Green"}]
        };

        const contextQuestions = {
            'Chest Pain': [
                { id: 'cp-onset', label: 'Onset (sudden/gradual)?' },
                { id: 'cp-character', label: 'Character (sharp/dull)?' },
                { id: 'cp-radiation', label: 'Radiation?' },
                { id: 'cp-exertion', label: 'Worse on exertion?' },
                { id: 'cp-pleuritic', label: 'Pleuritic (worse on inspiration)?' }
            ],
            'Abdominal Pain': [
                { id: 'ap-location', label: 'Location of pain (e.g., RUQ, central)?' },
                { id: 'ap-bowels', label: 'Change in bowel habit?' },
                { id: 'ap-urinary', label: 'Urinary symptoms?' },
                { id: 'ap-vomiting', label: 'Vomiting?' }
            ]
        };
        
        const differentialDiagnoses = {
            'Chest Pain': {
                'default': ['ACS', 'PE', 'Aortic Dissection', 'Pericarditis', 'Pneumothorax', 'Musculoskeletal Pain', 'GORD'],
                'pleuritic': ['PE', 'Pneumothorax', 'Pericarditis', 'Pneumonia', 'Musculoskeletal Pain']
            },
            'Abdominal Pain': {
                'default': ['Appendicitis', 'Bowel Obstruction', 'Pancreatitis', 'Cholecystitis', 'Diverticulitis', 'AAA', 'Gastritis']
            },
            'Overdose and Poisoning': {
                'default': ['Paracetamol Overdose', 'Salicylate Overdose', 'Opioid Overdose', 'TCA Overdose', 'Serotonin Syndrome']
            }
        };

        const guidelineLinks = {
            'Sepsis': 'https://www.nice.org.uk/guidance/ng51',
            'Chest Pain': 'https://www.nice.org.uk/guidance/ng185',
            'DVT': 'https://cks.nice.org.uk/topics/deep-vein-thrombosis/',
            'Head Injury': 'https://www.nice.org.uk/guidance/cg176'
        };

        // --- STATE MANAGEMENT ---
        let appState = {};
        let timers = {};

        // --- UI ELEMENT CACHE ---
        const ui = {
            container: document.querySelector('.container'),
            mtsFlowchart: document.getElementById('mts-flowchart'),
            discriminatorsContainer: document.getElementById('discriminators-container'),
            obsFormContainer: document.getElementById('obs-form-container'),
            visualEWSContainer: document.getElementById('visual-ews-container'),
            totalEwsScore: document.getElementById('total-ews-score'),
            criticalAlertBanner: document.getElementById('critical-alert-banner'),
            alertsList: document.getElementById('alerts-list'),
            timersContainer: document.getElementById('timers-container'),
            scoresList: document.getElementById('scores-list'),
            diffDiagList: document.getElementById('diff-diag-list'),
            summaryPriority: document.getElementById('summary-priority-display'),
            actionsList: document.getElementById('actions-list'),
            eprNote: document.getElementById('epr-note'),
            sbarNote: document.getElementById('sbar-note'),
            contextQuestionsContainer: document.getElementById('context-questions-container'),
            obsTitle: document.getElementById('obs-title'),
            overrideCategory: document.getElementById('override-category'),
            overrideReasonContainer: document.getElementById('override-reason-container'),
            overrideReason: document.getElementById('override-reason'),
            tickAllActions: document.getElementById('tick-all-actions'),
            paediatricDosingCard: document.getElementById('paediatric-dosing-card'),
            dosingWeight: document.getElementById('dosing-weight'),
            paediatricDosingResults: document.getElementById('paediatric-dosing-results'),
            decisionSupportCard: document.getElementById('decision-support-card'),
            decisionSupportContent: document.getElementById('decision-support-content'),
        };
        
        // --- INITIALIZATION ---
        function initialize() {
            populateFlowcharts();
            addEventListeners();
            resetApp();
        }

        function populateFlowcharts() {
            const flowchartNames = Object.keys(mtsFlowcharts).sort();
            flowchartNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                ui.mtsFlowchart.appendChild(option);
            });
        }
        
        function addEventListeners() {
            ui.container.addEventListener('input', handleInputChange);
            ui.container.addEventListener('change', handleInputChange);
            ui.discriminatorsContainer.addEventListener('click', handleDiscriminatorClick);
            document.getElementById('btn-reset').addEventListener('click', resetApp);
            document.getElementById('btn-copy-note').addEventListener('click', () => copyToClipboard('btn-copy-note'));
            document.getElementById('btn-copy-sbar').addEventListener('click', () => copyToClipboard('btn-copy-sbar'));
            ui.tickAllActions.addEventListener('change', handleTickAllActions);
            ui.overrideCategory.addEventListener('change', () => {
                ui.overrideReasonContainer.style.display = ui.overrideCategory.value ? 'block' : 'none';
            });
        }
        
        // --- MAIN APP LOGIC ---
        function handleInputChange(e) {
            gatherState();
            runCalculations();
            updateUI();
        }
        
        function handleDiscriminatorClick(e) {
            if (e.target.classList.contains('discriminator')) {
                const previousSelected = ui.discriminatorsContainer.querySelector('.selected-discriminator');
                if (previousSelected) {
                    previousSelected.classList.remove('selected-discriminator');
                    previousSelected.style.fontWeight = 'normal';
                }
                
                const el = e.target;
                el.classList.add('selected-discriminator');
                el.style.fontWeight = 'bold'; 
                
                appState.mts = {
                    priority: el.dataset.priority,
                    discriminator: el.dataset.text,
                };
                handleInputChange();
            }
        }
        
        function handleTickAllActions(e) {
            const isChecked = e.target.checked;
            const actionCheckboxes = ui.actionsList.querySelectorAll('input[type="checkbox"]');
            actionCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            handleInputChange();
        }

        function gatherState() {
            let sexValue = document.getElementById('patient-sex').value;
            if (sexValue === 'Other') sexValue = document.getElementById('other-sex-text').value || 'Other (unspecified)';
            
            appState.patient = {
                id: document.getElementById('patient-id').value,
                age: parseInt(document.getElementById('patient-age').value, 10),
                weight: parseFloat(document.getElementById('patient-weight').value),
                sex: sexValue,
                isPregnant: document.getElementById('patient-pregnant').checked,
                isReferral: document.getElementById('patient-referral').checked
            };
            appState.history = {
                pmh: document.getElementById('pmh').value,
                meds: document.getElementById('meds').value,
                allergies: document.getElementById('allergies').value,
            };

            appState.presentingComplaint = ui.mtsFlowchart.value;
            appState.complaintInfo = document.getElementById('complaint-info').value;
            
            appState.context = {};
            const questions = document.querySelectorAll('.context-input, .decision-support-checkbox');
            questions.forEach(q => { appState.context[q.id] = q.value || q.checked; });
            
            appState.override = {
                category: ui.overrideCategory.value,
                reason: ui.overrideReason.value,
            };

            appState.observations = getObsData();
        }

        function runCalculations() {
            appState.scores = {};
            if (!appState.patient || isNaN(appState.patient.age)) return;

            if (appState.patient.isPregnant) {
                 appState.scores.meows = calculateMEOWS(appState.observations);
            } else if (appState.patient.age >= 16) {
                 appState.scores.news2 = calculateNEWS2(appState.observations);
                 appState.scores.qsofa = calculateQSOFA(appState.observations);
                 appState.scores.crb65 = calculateCRB65(appState.observations, appState.patient.age);
            } else {
                 appState.scores.pews = calculatePEWS(appState.observations, appState.patient.age);
            }
            
            checkCriticalObservations(appState.observations, appState.scores);
        }

        function updateUI() {
            updateObsForm();
            updateMTSSection();
            updateEWSVisuals();
            updatePaediatricDosing();
            updateDecisionSupport();
            updateScoresAndDifferentials();
            updateActionPlan();
            updateNotes();
        }
        
        function updateObsForm() {
            const age = appState.patient?.age;
            const isPregnant = appState.patient?.isPregnant;
            let currentForm = ui.obsFormContainer.dataset.formType;
            let newFormType = 'none';

            if (!isNaN(age)) {
                if (isPregnant) newFormType = 'meows';
                else if (age < 16) newFormType = 'pews';
                else newFormType = 'news2';
            }

            if (currentForm !== newFormType) {
                ui.obsFormContainer.dataset.formType = newFormType;
                let html = '<p>Enter patient age to see observation fields.</p>';
                const ewsDisplay = document.getElementById('ews-display-container');
                ewsDisplay.style.display = 'none';
                if (newFormType === 'meows') {
                    ui.obsTitle.textContent = "Obstetric Observations (MEOWS)";
                    html = getMEOWSForm();
                } else if (newFormType === 'pews') {
                    const ageGroup = getPedsAgeGroup(age);
                    ui.obsTitle.textContent = `Paediatric Observations (PEWS ${ageGroup})`;
                    html = getPEWSForm(age);
                    ewsDisplay.style.display = 'block';
                } else if (newFormType === 'news2') {
                    ui.obsTitle.textContent = "Physiological Observations (NEWS2)";
                    html = getNEWS2Form();
                    ewsDisplay.style.display = 'block';
                }
                ui.obsFormContainer.innerHTML = html;
            }
        }

        function updateMTSSection() {
            const complaint = appState.presentingComplaint;
            if (complaint && complaint !== ui.contextQuestionsContainer.dataset.complaint) {
                ui.contextQuestionsContainer.dataset.complaint = complaint;
                ui.contextQuestionsContainer.innerHTML = '';
                if (contextQuestions[complaint]) {
                    let html = '<hr><label>Contextual Questions:</label>';
                    contextQuestions[complaint].forEach(q => {
                        html += `<div class="form-group"><label for="${q.id}">${q.label}</label><input type="text" id="${q.id}" class="context-input"></div>`;
                    });
                    ui.contextQuestionsContainer.innerHTML = html;
                }
            } else if (!complaint) {
                 ui.contextQuestionsContainer.innerHTML = '';
            }

            if (complaint && complaint !== ui.discriminatorsContainer.dataset.complaint) {
                ui.discriminatorsContainer.dataset.complaint = complaint;
                ui.discriminatorsContainer.innerHTML = '';
                const discriminators = mtsFlowcharts[complaint];
                if (discriminators) {
                    discriminators.forEach(disc => {
                        const div = document.createElement('div');
                        div.className = `discriminator priority-${disc.priority}`;
                        div.textContent = disc.text;
                        div.dataset.priority = disc.priority;
                        div.dataset.text = disc.text;
                        ui.discriminatorsContainer.appendChild(div);
                    });
                }
            } else if (!complaint) {
                 ui.discriminatorsContainer.innerHTML = '<p>Select a complaint first.</p>';
            }
            
            const meds = appState.history?.meds?.toLowerCase() || '';
            const existingHighlight = ui.discriminatorsContainer.querySelector('.highlight');
            if (existingHighlight) existingHighlight.classList.remove('highlight');
            if (complaint === 'Head Injury' && (meds.includes('anticoagulant') || meds.includes('warfarin') || meds.includes('apixaban') || meds.includes('rivaroxaban') || meds.includes('dabigatran') || meds.includes('edoxaban'))) {
                const el = Array.from(ui.discriminatorsContainer.children).find(d => d.textContent === 'On anticoagulants');
                if (el) el.classList.add('highlight');
            }
        }
        
        function updateEWSVisuals() {
            if (appState.scores?.news2) {
                const { score } = appState.scores.news2;
                ui.totalEwsScore.textContent = score;
                renderVisualEWS('news2');
            } else if (appState.scores?.pews) {
                const { score } = appState.scores.pews;
                ui.totalEwsScore.textContent = score;
                renderVisualEWS('pews');
            } else {
                ui.totalEwsScore.textContent = 'N/A';
                ui.visualEWSContainer.innerHTML = '';
            }
        }
        
        function updatePaediatricDosing() {
            const { age, weight } = appState.patient;
            if (!isNaN(age) && age < 16 && !isNaN(weight) && weight > 0) {
                ui.paediatricDosingCard.style.display = 'block';
                ui.dosingWeight.textContent = `${weight} kg`;
                
                const paracetamolDose = 15 * weight;
                const ibuprofenDose = 10 * weight;
                const fluidBolus = 20 * weight;
                
                ui.paediatricDosingResults.innerHTML = `
                    <p><strong>Paracetamol:</strong> ${paracetamolDose.toFixed(0)} mg (15mg/kg)</p>
                    <p><strong>Ibuprofen:</strong> ${ibuprofenDose.toFixed(0)} mg (10mg/kg)</p>
                    <p><strong>IV Fluid Bolus (0.9% NaCl):</strong> ${fluidBolus.toFixed(0)} ml (20ml/kg)</p>
                `;
            } else {
                ui.paediatricDosingCard.style.display = 'none';
            }
        }

        function updateDecisionSupport() {
            const complaint = appState.presentingComplaint;
            const context = appState.context;
            
            let content = '';
            let showCard = false;

            if (complaint === 'Head Injury') {
                showCard = true;
                const criteria = [
                    { id: 'hi_gcs_less_14', text: 'GCS less than 14' },
                    { id: 'hi_open_fracture', text: 'Suspected open or depressed skull fracture' },
                    { id: 'hi_seizure', text: 'Post-traumatic seizure' },
                    { id: 'hi_neuro_deficit', text: 'Focal neurological deficit' },
                    { id: 'hi_loc_gt_5min', text: 'Loss of consciousness > 5 minutes' },
                    { id: 'hi_amnesia', text: 'Amnesia > 5 minutes' },
                    { id: 'hi_vomit_gt_1', text: 'More than 1 episode of vomiting' },
                ];
                let recommendation = 'NICE Guideline: CT Head Scan Not Indicated';
                let recommendClass = 'recommend-no';
                if (criteria.some(c => context[c.id])) {
                    recommendation = 'NICE Guideline: CT Head Scan Indicated';
                    recommendClass = 'recommend-yes';
                }
                
                content = `
                    <h3>NICE Head Injury (CT Head < 16) <a href="${guidelineLinks['Head Injury']}" target="_blank">(Guideline)</a></h3>
                    ${criteria.map(c => `
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="${c.id}" class="decision-support-checkbox">
                            <label for="${c.id}">${c.text}</label>
                        </div>`).join('')}
                    <div class="decision-support-recommendation ${recommendClass}">${recommendation}</div>
                `;
            } else if (complaint === 'Limb Problem (Injury)') {
                showCard = true;
                const criteria = [
                    { id: 'oa_malleolar_tender', text: 'Bone tenderness at posterior edge or tip of lateral or medial malleolus' },
                    { id: 'oa_inability_wb', text: 'Inability to weight bear both immediately and in the emergency department' },
                    { id: 'oa_navicular_tender', text: 'Bone tenderness at navicular bone' },
                    { id: 'oa_5th_meta_tender', text: 'Bone tenderness at base of 5th metatarsal' },
                ];
                let recommendation = 'Ottawa Ankle Rules Negative: X-Ray Not Indicated';
                let recommendClass = 'recommend-no';
                if (criteria.some(c => context[c.id])) {
                    recommendation = 'Ottawa Ankle Rules Positive: X-Ray Indicated';
                    recommendClass = 'recommend-yes';
                }
                
                 content = `
                    <h3>Ottawa Ankle Rules</h3>
                    ${criteria.map(c => `
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="${c.id}" class="decision-support-checkbox">
                            <label for="${c.id}">${c.text}</label>
                        </div>`).join('')}
                    <div class="decision-support-recommendation ${recommendClass}">${recommendation}</div>
                `;
            }
            
            ui.decisionSupportCard.style.display = showCard ? 'block' : 'none';
            ui.decisionSupportContent.innerHTML = content;
        }

        function updateScoresAndDifferentials() {
            ui.scoresList.innerHTML = '';
            const scores = appState.scores;
            if (!scores || Object.keys(scores).length === 0 || Object.values(scores).every(s => s === undefined)) {
                 ui.scoresList.innerHTML = '<li>No scores calculated.</li>';
            } else {
                if (scores.news2) ui.scoresList.innerHTML += `<li><strong>NEWS2:</strong> ${scores.news2.score} (${scores.news2.response})</li>`;
                if (scores.pews) ui.scoresList.innerHTML += `<li><strong>PEWS:</strong> ${scores.pews.score} (${scores.pews.response})</li>`;
                if (scores.qsofa) ui.scoresList.innerHTML += `<li><strong>qSOFA:</strong> ${scores.qsofa.score}</li>`;
                if (scores.crb65) ui.scoresList.innerHTML += `<li><strong>CRB-65:</strong> ${scores.crb65.score} (${scores.crb65.recommendation})</li>`;
            }
            
            const complaint = appState.presentingComplaint;
            ui.diffDiagList.innerHTML = '';
            if (complaint && differentialDiagnoses[complaint]) {
                let diffs = differentialDiagnoses[complaint].default;
                if (appState.context['cp-pleuritic'] && differentialDiagnoses[complaint].pleuritic) {
                    diffs = differentialDiagnoses[complaint].pleuritic;
                }
                diffs.forEach(d => ui.diffDiagList.innerHTML += `<li>${d}</li>`);
            } else {
                ui.diffDiagList.innerHTML = '<li>Select a primary complaint to generate.</li>';
            }
        }
        
        function updateActionPlan() {
            const finalPriority = appState.override?.category || appState.mts?.priority;

            if (finalPriority) {
                const priorityMap = { Red: "1 - Red", Orange: "2 - Orange", Yellow: "3 - Yellow", Green: "4 - Green", Blue: "5 - Blue" };
                ui.summaryPriority.textContent = priorityMap[finalPriority];
                ui.summaryPriority.className = `summary-priority-${finalPriority}`;
            } else {
                ui.summaryPriority.textContent = 'Awaiting Triage Category';
                ui.summaryPriority.className = '';
            }
            
            const recommendations = generateRecommendations();
            if (recommendations.length > 0) {
                ui.actionsList.innerHTML = recommendations.map((rec, index) => `
                    <li>
                        <input type="checkbox" id="action-${index}" class="action-checkbox" checked>
                        <label for="action-${index}">${rec.text}</label>
                        ${rec.link ? `<a href="${rec.link}" target="_blank">(Guideline)</a>` : ''}
                    </li>
                `).join('');
            } else {
                ui.actionsList.innerHTML = '<li>Routine assessment.</li>';
            }
        }
        
        function updateNotes() {
            ui.eprNote.value = generateEPRNote();
            ui.sbarNote.value = generateSBAR();
        }

        function checkCriticalObservations(obs, scores) {
            let alerts = [];
            if (obs.sats < 90 && obs.sats > 0) alerts.push('CRITICAL HYPOXIA');
            if (obs.consciousness === 'U' || obs.consciousness === 'Unresponsive') alerts.push('PATIENT UNRESPONSIVE');
            if (obs.sbp < 90 && obs.sbp > 0) alerts.push('SEVERE HYPOTENSION');
            if (scores?.qsofa?.score >= 2) alerts.push('SUSPECTED SEPSIS');

            if (alerts.length > 0) {
                ui.criticalAlertBanner.textContent = alerts.join(' / ');
                ui.criticalAlertBanner.style.display = 'block';
            } else {
                ui.criticalAlertBanner.style.display = 'none';
            }
            
            ui.alertsList.innerHTML = '';
            alerts.forEach(a => { ui.alertsList.innerHTML += `<li>${a}</li>`});

            if (alerts.includes('SUSPECTED SEPSIS') && !timers.sepsis) {
                startTimer('sepsis', 'Time to Antibiotics', 3600);
            } else if (!alerts.includes('SUSPECTED SEPSIS') && timers.sepsis) {
                stopTimer('sepsis');
            }
        }
        
        function startTimer(id, label, durationSeconds) {
            if (timers[id]) clearInterval(timers[id].interval);
            
            let remaining = durationSeconds;
            const timerEl = document.createElement('div');
            timerEl.id = `timer-${id}`;
            timerEl.innerHTML = `<div class="timer"></div><span class="timer-label">${label}</span>`;
            ui.timersContainer.appendChild(timerEl);
            
            const updateDisplay = () => {
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                timerEl.querySelector('.timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                remaining--;
                if (remaining < 0) {
                    clearInterval(timers[id].interval);
                    timerEl.querySelector('.timer').textContent = "TIME UP";
                }
            };
            
            updateDisplay();
            timers[id] = {
                interval: setInterval(updateDisplay, 1000),
                element: timerEl
            };
        }
        
        function stopTimer(id) {
            if(timers[id]) {
                clearInterval(timers[id].interval);
                timers[id].element.remove();
                delete timers[id];
            }
        }
        
        function generateRecommendations() {
            const { patient, scores, override, mts, complaintInfo, presentingComplaint } = appState;
            let actions = [];

            if (!patient || !mts) return actions;

            const finalPriority = override?.category || mts?.priority;
            const pewsScore = scores?.pews?.score;

            if (finalPriority === 'Red' || finalPriority === 'Orange' || (scores?.news2 && scores.news2.score >= 5) || (pewsScore && pewsScore >= 5)) {
                actions.push({ text: "Insert peripheral IV cannula" });
                actions.push({ text: "Attach cardiac monitor" });
                actions.push({ text: "Request 'Stat' bloods (FBC, U&E, LFT, CRP, Lactate)" });
            }
            if (scores?.qsofa?.score >= 2) {
                actions.push({ text: "INITIATE SEPSIS SIX PATHWAY", link: guidelineLinks['Sepsis'] });
            }
            // Keyword-based intelligent actions
            const lowerComplaintInfo = complaintInfo?.toLowerCase() || '';
            if (lowerComplaintInfo.includes('paracetamol') && lowerComplaintInfo.includes('overdose')) {
                actions.push({ text: "Request Paracetamol Level" });
                actions.push({ text: "Request Salicylate Level" });
            }
            
            // Pregnancy test logic
            const pregTestComplaints = ["Abdominal Pain", "Collapse", "Overdose and Poisoning", "Unwell Adult", "Urinary Problems", "Falls", "Diarrhoea and Vomiting"];
            if (patient.sex === 'Female' && patient.age >= 12 && patient.age <= 55 && !patient.isPregnant && pregTestComplaints.includes(presentingComplaint)) {
                actions.push({ text: "Consider pregnancy test (Urine hCG)" });
            }
            
            // Remove duplicates
            const uniqueActions = actions.filter((action, index, self) =>
                index === self.findIndex((a) => a.text === action.text)
            );

            return uniqueActions;
        }
        
        function generateEPRNote() {
            if (!appState.patient || isNaN(appState.patient.age)) return "Awaiting patient data...";
            let note = `TRIAGE NOTE\n----------------------------------------\n`;
            note += `Patient: ${appState.patient.id || 'N/A'}, ${appState.patient.age}y, ${appState.patient.sex}, ${appState.patient.weight || 'N/A'} kg\n`;
            if (appState.patient.isReferral) note += `Source: GP / Specialty Referral\n`;
            
            note += `\nALLERGIES:\n${appState.history.allergies.trim()}\n`;
            note += `\nPAST MEDICAL HISTORY:\n${appState.history.pmh.trim()}\n`;
            note += `\nMEDICATIONS:\n${appState.history.meds.trim()}\n`;

            note += `\nPRESENTATION:\n`;
            note += `- Complaint: ${appState.presentingComplaint}\n`;
            if (appState.complaintInfo) note += `- History: ${appState.complaintInfo.trim()}\n`;
            if (appState.mts) {
                 note += `- MTS Category: ${appState.mts.priority} (Discriminator: ${appState.mts.discriminator})\n`;
            }
            if (appState.override?.category) {
                note += `\n** CLINICIAN OVERRIDE **\n`;
                note += `- Final Triage Category: ${appState.override.category}\n`;
                note += `- Reason: ${appState.override.reason.trim()}\n`;
            }

            note += `\nOBSERVATIONS:\n`;
            const obs = appState.observations || {};
            if (obs.rr) note += `- RR: ${obs.rr}\n`;
            if (obs.sats) note += `- Sats: ${obs.sats}% ${obs.suppO2 ? 'on O2' : 'on Air'}\n`;
            if (obs.sbp) note += `- BP: ${obs.sbp}/${obs.dbp}\n`;
            if (obs.hr) note += `- HR: ${obs.hr}\n`;
            if (obs.temp) note += `- Temp: ${obs.temp}C\n`;
            if (obs.consciousness) note += `- GCS/AVPU: ${obs.consciousness}\n`;

            note += `\nCALCULATED SCORES:\n`;
            const scores = appState.scores || {};
            if (scores.news2) note += `- NEWS2: ${scores.news2.score} (${scores.news2.response})\n`;
            if (scores.pews) note += `- PEWS: ${scores.pews.score} (${scores.pews.response})\n`;
            
            note += `\nACTION PLAN:\n`;
            const actionItems = ui.actionsList.querySelectorAll('li');
            let tickedActions = 0;
            actionItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const label = item.querySelector('label');
                if (checkbox && checkbox.checked && label) {
                    note += `- ${label.textContent}\n`;
                    tickedActions++;
                }
            });
            if(tickedActions === 0 && actionItems.length > 0) note += `- No actions selected from plan.\n`;


            note += `----------------------------------------\n`;
            return note;
        }

        function generateSBAR() {
            if (!appState.patient || isNaN(appState.patient.age)) return "Awaiting patient data...";
            let finalPriority = appState.override?.category || appState.mts?.priority;
            let note = `SBAR HANDOVER\n----------------------------------------\n`;
            
            note += `SITUATION:\n`;
            note += `This is ${appState.patient.id || 'a patient'}, a ${appState.patient.age}-year-old ${appState.patient.sex.toLowerCase()} weighing ${appState.patient.weight || 'N/A'} kg, who has presented with ${appState.presentingComplaint}.\n`;
            note += `Their triage category is ${finalPriority || 'not yet determined'}.\n`;
            
            note += `\nBACKGROUND:\n`;
            note += `Allergies: ${appState.history.allergies}\n`;
            note += `Past History: ${appState.history.pmh}\n`;
            note += `Medications: ${appState.history.meds}\n`;
            
            note += `\nASSESSMENT:\n`;
            const obs = appState.observations || {};
            note += `Observations are: BP ${obs.sbp || 'N/A'}/${obs.dbp || 'N/A'}, HR ${obs.hr || 'N/A'}, RR ${obs.rr || 'N/A'}, Sats ${obs.sats || 'N/A'}%.\n`;
            const scores = appState.scores || {};
            if(scores.news2) note += `The NEWS2 score is ${scores.news2.score}.\n`;
            if(scores.pews) note += `The PEWS score is ${scores.pews.score}.\n`;
            if(scores.qsofa?.score >=2) note += `The patient is flagging for sepsis.\n`;

            note += `\nRECOMMENDATION:\n`;
            note += `I am concerned about [state your primary concern].\n`;
            note += `The suggested action plan includes: ${Array.from(ui.actionsList.querySelectorAll('input:checked + label')).map(l => l.textContent).join(', ')}.\n`;
            note += `I recommend urgent review.\n`;
            note += `----------------------------------------\n`;
            return note;
        }
        
        function getObsData() {
            const formType = ui.obsFormContainer.dataset.formType;
            let obs = {};
            if (formType === 'news2') {
                obs = { rr: parseFloat(document.getElementById('rr')?.value), sats: parseFloat(document.getElementById('sats')?.value), hypercapnic: document.getElementById('hypercapnic')?.checked, suppO2: document.getElementById('supp-o2')?.checked, sbp: parseFloat(document.getElementById('sbp')?.value), dbp: parseFloat(document.getElementById('dbp')?.value), hr: parseFloat(document.getElementById('hr')?.value), consciousness: document.getElementById('consciousness')?.value, temp: parseFloat(document.getElementById('temp')?.value) };
            } else if (formType === 'pews') {
                obs = { consciousness: document.getElementById('pews-behaviour')?.value, cvs: document.getElementById('pews-cvs')?.value, rr: parseFloat(document.getElementById('pews-rr')?.value), work_of_breathing: document.getElementById('pews-wob')?.value, suppO2: document.getElementById('pews-supp-o2')?.checked };
            }
            return obs;
        }
        
        function getNEWS2Form() {
            return `
                <div class="form-group"><label for="rr">Resp Rate</label><div class="input-group"><input type="number" id="rr" min="0"><span>/min</span></div></div>
                <div class="form-group"><label for="sats">O Sats</label><div class="input-group"><input type="number" id="sats" min="0" max="100"><span>%</span></div></div>
                <div class="form-group checkbox-group"><input type="checkbox" id="hypercapnic"><label for="hypercapnic">Scale 2</label></div>
                <div class="form-group checkbox-group"><input type="checkbox" id="supp-o2"><label for="supp-o2">On O</label></div>
                <div class="form-group"><label for="sbp">Systolic BP</label><div class="input-group"><input type="number" id="sbp" min="0"><span>mmHg</span></div></div>
                <div class="form-group"><label for="dbp">Diastolic BP</label><div class="input-group"><input type="number" id="dbp" min="0"><span>mmHg</span></div></div>
                <div class="form-group"><label for="hr">Pulse Rate</label><div class="input-group"><input type="number" id="hr" min="0"><span>bpm</span></div></div>
                <div class="form-group"><label for="consciousness">Consciousness</label><select id="consciousness"><option value="A">Alert</option><option value="C">New Confusion</option><option value="V">Voice</option><option value="P">Pain</option><option value="U">Unresponsive</option></select></div>
                <div class="form-group"><label for="temp">Temperature</label><div class="input-group"><input type="number" id="temp" step="0.1"><span>C</span></div></div>
            `;
        }
        
        function getPEWSForm(age) {
            const ageGroup = getPedsAgeGroup(age);
            const rrRanges = pewsParams[ageGroup].rr.ranges;
            const hrRanges = pewsParams[ageGroup].hr.ranges; // We will use this for the CVS select options
            
            return `
                <div class="form-group">
                    <label for="pews-behaviour">Behaviour / Consciousness</label>
                    <select id="pews-behaviour">
                        <option value="Playing/Appropriate">Playing / Appropriate</option>
                        <option value="Sleeping">Sleeping</option>
                        <option value="Irritable">Irritable</option>
                        <option value="Lethargic">Lethargic</option>
                        <option value="Unresponsive">Unresponsive / Confused</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pews-cvs">Cardiovascular (HR & Cap Refill)</label>
                    <select id="pews-cvs">
                        <option value="Normal">Normal Colour & HR in normal range (${hrRanges[0].range})</option>
                        <option value="Pale">Pale & HR ${hrRanges[1].range}</option>
                        <option value="Grey/Blue">Grey/Blue, Tachycardic (${hrRanges[2].range}) & CRT > 2s</option>
                        <option value="Bradycardic">Bradycardic (${hrRanges[3].range}) & CRT > 5s</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pews-rr">Respiratory Rate</label>
                    <div class="input-group"><input type="number" id="pews-rr" min="0"><span>/min (Normal: ${rrRanges.find(r=>r.score===0).range})</span></div>
                </div>
                 <div class="form-group">
                    <label for="pews-wob">Work of Breathing</label>
                    <select id="pews-wob">
                        <option value="None">None</option>
                        <option value="Mild">Mild Recession</option>
                        <option value="Moderate">Moderate Recession / Nasal Flaring</option>
                        <option value="Severe">Severe Recession / Grunting</option>
                    </select>
                </div>
                 <div class="form-group checkbox-group">
                    <input type="checkbox" id="pews-supp-o2"><label for="pews-supp-o2">On O to maintain Sats</label>
                </div>
            `;
        }

        function getMEOWSForm() {
            return `<p>MEOWS input form not implemented in this demo.</p>`;
        }
        
        function calculateNEWS2(obs) {
            if (Object.values(obs).every(v => !v || v === 'A')) return undefined;
            let score = 0;
            let paramScores = {};
            
            // RR
            if (obs.rr <= 8) { score += 3; paramScores.rr = 3; } 
            else if (obs.rr >= 25) { score += 3; paramScores.rr = 3; } 
            else if (obs.rr >= 21) { score += 2; paramScores.rr = 2; } 
            else if (obs.rr <= 11) { score += 1; paramScores.rr = 1; } 
            else { paramScores.rr = 0; }

            // Sats
            if (obs.sats <= 91) { score += 3; paramScores.sats = 3; } 
            else if (obs.sats <= 93) { score += 2; paramScores.sats = 2; } 
            else if (obs.sats <= 95) { score += 1; paramScores.sats = 1; } 
            else { paramScores.sats = 0; }
            
            // Supp O2
            if (obs.suppO2) { score += 2; paramScores.suppO2 = 2; } 
            else { paramScores.suppO2 = 0; }
            
            // SBP
            if (obs.sbp <= 90) { score += 3; paramScores.sbp = 3; } 
            else if (obs.sbp >= 220) { score += 3; paramScores.sbp = 3; } 
            else if (obs.sbp <= 100) { score += 2; paramScores.sbp = 2; } 
            else if (obs.sbp <= 110) { score += 1; paramScores.sbp = 1; } 
            else { paramScores.sbp = 0; }
            
            // HR
            if (obs.hr <= 40) { score += 3; paramScores.hr = 3; } 
            else if (obs.hr >= 131) { score += 3; paramScores.hr = 3; } 
            else if (obs.hr >= 111) { score += 2; paramScores.hr = 2; } 
            else if (obs.hr <= 50 || obs.hr >= 91) { score += 1; paramScores.hr = 1; } 
            else { paramScores.hr = 0; }
            
            // Consciousness
            if (obs.consciousness && obs.consciousness !== 'A') { score += 3; paramScores.consciousness = 3; } 
            else { paramScores.consciousness = 0; }
            
            // Temp
            if (obs.temp <= 35.0) { score += 3; paramScores.temp = 3; } 
            else if (obs.temp >= 39.1) { score += 2; paramScores.temp = 2; } 
            else if (obs.temp <= 36.0 || obs.temp >= 38.1) { score += 1; paramScores.temp = 1; } 
            else { paramScores.temp = 0; }

            let response = "Low risk";
            if (score >= 7) response = "High risk - Emergency"; 
            else if (score >= 5) response = "Medium risk - Urgent review"; 
            else if (score >=1) response = "Low-medium risk";

            return { score, response, paramScores };
        }
        
        const pewsParams = { // UK-based PEWS parameters
            '<1yr': {
                behaviour: { 'Playing/Appropriate': 0, 'Sleeping': 1, 'Irritable': 2, 'Lethargic': 3, 'Unresponsive': 3 },
                cvs: { 'Normal': 0, 'Pale': 1, 'Grey/Blue': 2, 'Bradycardic': 3},
                rr: { ranges: [{range: '<30', score: 2}, {range: '30-39', score: 0}, {range: '40-49', score: 1}, {range: '50-59', score: 2}, {range: '>60', score: 3}] },
                hr: { ranges: [{range: '100-180'}, {range: '<100 or 181-200'}, {range: '>200'}, {range: '<80'}] },
            },
            '1-4yr': {
                behaviour: { 'Playing/Appropriate': 0, 'Sleeping': 1, 'Irritable': 2, 'Lethargic': 3, 'Unresponsive': 3 },
                cvs: { 'Normal': 0, 'Pale': 1, 'Grey/Blue': 2, 'Bradycardic': 3},
                rr: { ranges: [{range: '<20', score: 2}, {range: '20-29', score: 0}, {range: '30-39', score: 1}, {range: '40-49', score: 2}, {range: '>50', score: 3}] },
                hr: { ranges: [{range: '90-160'}, {range: '<90 or 161-180'}, {range: '>180'}, {range: '<70'}] },
            },
            '5-11yr': {
                behaviour: { 'Playing/Appropriate': 0, 'Sleeping': 1, 'Irritable': 2, 'Lethargic': 3, 'Unresponsive': 3 },
                cvs: { 'Normal': 0, 'Pale': 1, 'Grey/Blue': 2, 'Bradycardic': 3},
                rr: { ranges: [{range: '<15', score: 2}, {range: '15-24', score: 0}, {range: '25-34', score: 1}, {range: '35-44', score: 2}, {range: '>45', score: 3}] },
                hr: { ranges: [{range: '80-140'}, {range: '<80 or 141-160'}, {range: '>160'}, {range: '<60'}] },
            },
             '12+yr': {
                behaviour: { 'Playing/Appropriate': 0, 'Sleeping': 1, 'Irritable': 2, 'Lethargic': 3, 'Unresponsive': 3 },
                cvs: { 'Normal': 0, 'Pale': 1, 'Grey/Blue': 2, 'Bradycardic': 3},
                rr: { ranges: [{range: '<12', score: 2}, {range: '12-20', score: 0}, {range: '21-30', score: 1}, {range: '31-40', score: 2}, {range: '>41', score: 3}] },
                hr: { ranges: [{range: '60-120'}, {range: '<60 or 121-140'}, {range: '>140'}, {range: '<50'}] },
            }
        };
        const pewsWobScores = {'None': 0, 'Mild': 1, 'Moderate': 2, 'Severe': 3};

        function getPedsAgeGroup(age) {
            if (age < 1) return '<1yr'; if (age >= 1 && age <= 4) return '1-4yr'; if (age >= 5 && age <= 11) return '5-11yr'; if (age >= 12 && age <= 15) return '12+yr';
            return '12+yr'; // Default for safety
        }

        function calculatePEWS(obs, age) {
            if (!obs || isNaN(age)) return undefined;
            const ageGroup = getPedsAgeGroup(age);
            const params = pewsParams[ageGroup];
            let score = 0;
            let paramScores = {};
            
            paramScores.behaviour = params.behaviour[obs.consciousness] || 0;
            paramScores.cvs = params.cvs[obs.cvs] || 0;
            
            let rrScore = 0;
            const rr = obs.rr;
            if (rr) {
                // Find the correct range and score
                for(const range of params.rr.ranges) {
                    if(range.range.startsWith('<')) {
                        if(rr < parseInt(range.range.substring(1))) rrScore = range.score;
                    } else if (range.range.startsWith('>')) {
                        if(rr > parseInt(range.range.substring(1))) rrScore = range.score;
                    } else {
                        const [min, max] = range.range.split('-').map(Number);
                        if(rr >= min && rr <= max) {
                            rrScore = range.score;
                            break;
                        }
                    }
                }
            }
            paramScores.rr = rrScore;

            paramScores.wob = pewsWobScores[obs.work_of_breathing] || 0;
            paramScores.suppO2 = obs.suppO2 ? 2 : 0;
            
            score = paramScores.behaviour + paramScores.cvs + paramScores.rr + paramScores.wob + paramScores.suppO2;

            let response = "Low risk";
            if (score >= 5) response = "High risk - Emergency"; else if (score >= 3) response = "Medium risk - Urgent review";
            return { score, response, paramScores };
        }

        function calculateQSOFA(obs) { let score = 0; if (obs.sbp <= 100) score++; if (obs.rr >= 22) score++; if (obs.consciousness !== 'A' && obs.consciousness) score++; return { score }; }
        function calculateCRB65(obs, age) { let score = 0; if (obs.consciousness !== 'A' && obs.consciousness) score++; if (obs.rr >= 30) score++; if (obs.sbp < 90) score++; if (age >= 65) score++; let recommendation = "Low risk"; if (score >= 3) recommendation = "High risk"; else if (score >= 1) recommendation = "Intermediate risk"; return { score, recommendation }; }
        function calculateMEOWS(obs) { return { score: 'N/A', response: 'Not implemented' }; }

        function renderVisualEWS(scoreType) {
            let html = '';
            if(scoreType === 'news2'){
                 const obs = appState.observations;
                 const paramScores = appState.scores?.news2?.paramScores;
                 if (!obs || !paramScores) { ui.visualEWSContainer.innerHTML = ''; return; }

                const renderRow = (value, bands) => {
                    return bands.map(b => {
                        let active = '';
                        if (value >= b.lower && value <= b.upper) active = 'active-score';
                        return `<div class="ews-box score-${b.score} ${active}"></div>`;
                    }).join('');
                };

                const rrHtml = renderRow(obs.rr, [ {score: 3, lower: 0, upper: 8}, {score: 1, lower: 9, upper: 11}, {score: 0, lower: 12, upper: 20}, {score: 2, lower: 21, upper: 24}, {score: 3, lower: 25, upper: 999} ]);
                const satsHtml = renderRow(obs.sats, [ {score: 3, lower: 0, upper: 91}, {score: 2, lower: 92, upper: 93}, {score: 1, lower: 94, upper: 95}, {score: 0, lower: 96, upper: 100} ]);
                const sbpHtml = renderRow(obs.sbp, [ {score: 3, lower: 0, upper: 90}, {score: 2, lower: 91, upper: 100}, {score: 1, lower: 101, upper: 110}, {score: 0, lower: 111, upper: 219}, {score: 3, lower: 220, upper: 999} ]);
                const hrHtml = renderRow(obs.hr, [ {score: 3, lower: 0, upper: 40}, {score: 1, lower: 41, upper: 50}, {score: 0, lower: 51, upper: 90}, {score: 1, lower: 91, upper: 110}, {score: 2, lower: 111, upper: 130}, {score: 3, lower: 131, upper: 999} ]);
                const tempHtml = renderRow(obs.temp, [ {score: 3, lower: 0, upper: 35.0}, {score: 1, lower: 35.1, upper: 36.0}, {score: 0, lower: 36.1, upper: 38.0}, {score: 1, lower: 38.1, upper: 39.0}, {score: 2, lower: 39.1, upper: 99} ]);
                
                html = `
                    <div class="ews-row"><div class="ews-label">Resp Rate</div><div class="ews-track">${rrHtml}</div></div>
                    <div class="ews-row"><div class="ews-label">O Sats</div><div class="ews-track">${satsHtml}</div></div>
                    <div class="ews-row"><div class="ews-label">On O</div><div class="ews-track"><div class="ews-box score-0 ${!obs.suppO2 ? 'active-score' : ''}"></div><div class="ews-box score-2 ${obs.suppO2 ? 'active-score' : ''}"></div></div></div>
                    <div class="ews-row"><div class="ews-label">Systolic BP</div><div class="ews-track">${sbpHtml}</div></div>
                    <div class="ews-row"><div class="ews-label">Heart Rate</div><div class="ews-track">${hrHtml}</div></div>
                    <div class="ews-row"><div class="ews-label">Consciousness</div><div class="ews-track"><div class="ews-box score-0 ${obs.consciousness === 'A' ? 'active-score' : ''}"></div><div class="ews-box score-3 ${obs.consciousness !== 'A' && obs.consciousness ? 'active-score' : ''}"></div></div></div>
                    <div class="ews-row"><div class="ews-label">Temperature</div><div class="ews-track">${tempHtml}</div></div>
                `;

            } else if (scoreType === 'pews') {
                const ageGroup = getPedsAgeGroup(appState.patient.age);
                const scores = appState.scores.pews.paramScores;
                
                html += `<div class="ews-row"><div class="ews-label">Behaviour</div><div class="ews-track">${[0,1,2,3].map(s => `<div class="ews-box score-${s} ${scores.behaviour === s ? 'active-score' : ''}"></div>`).join('')}</div></div>`;
                html += `<div class="ews-row"><div class="ews-label">Cardiovascular</div><div class="ews-track">${[0,1,2,3].map(s => `<div class="ews-box score-${s} ${scores.cvs === s ? 'active-score' : ''}"></div>`).join('')}</div></div>`;
                html += `<div class="ews-row"><div class="ews-label">Resp Rate</div><div class="ews-track">${[2,0,1,2,3].map(s => `<div class="ews-box score-${s} ${scores.rr === s ? 'active-score' : ''}"></div>`).join('')}</div></div>`;
                html += `<div class="ews-row"><div class="ews-label">Work of Breath</div><div class="ews-track">${[0,1,2,3].map(s => `<div class="ews-box score-${s} ${scores.wob === s ? 'active-score' : ''}"></div>`).join('')}</div></div>`;
                html += `<div class="ews-row"><div class="ews-label">O Required</div><div class="ews-track">${[0,2].map(s => `<div class="ews-box score-${s} ${scores.suppO2 === s ? 'active-score' : ''}"></div>`).join('')}</div></div>`;
            }
            ui.visualEWSContainer.innerHTML = html;
        }

        function copyToClipboard(buttonId) {
            const button = document.getElementById(buttonId);
            const noteText = button.previousElementSibling;
            if (!noteText) return;

            noteText.select();
            noteText.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.disabled = true;
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            } catch (err) {
                const originalText = button.textContent;
                button.textContent = 'Failed!';
                button.disabled = true;
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        function resetApp() {
            appState = {};
            Object.keys(timers).forEach(stopTimer);
            timers = {};
            
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
                input.disabled = false;
            });

            ui.criticalAlertBanner.style.display = 'none';
            ui.alertsList.innerHTML = '';
            ui.timersContainer.innerHTML = '';
            ui.discriminatorsContainer.innerHTML = '<p>Select a complaint first.</p>';
            ui.contextQuestionsContainer.innerHTML = '';
            document.getElementById('other-sex-container').style.display = 'none';
            ui.overrideReasonContainer.style.display = 'none';
            ui.paediatricDosingCard.style.display = 'none';
            ui.decisionSupportCard.style.display = 'none';

            gatherState();
            runCalculations();
            updateUI();
        }
        
        function setupCheckboxToggle(checkboxId, textareaId, text) {
            const checkbox = document.getElementById(checkboxId);
            const textarea = document.getElementById(textareaId);
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    textarea.value = text;
                    textarea.disabled = true;
                } else {
                    textarea.value = '';
                    textarea.disabled = false;
                }
                handleInputChange();
            });
        }
        setupCheckboxToggle('pmh-nil', 'pmh', 'Nil known');
        setupCheckboxToggle('meds-nil', 'meds', 'Nil known');
        setupCheckboxToggle('allergies-nkda', 'allergies', 'NKDA');
        document.getElementById('patient-sex').addEventListener('change', (e) => {
            document.getElementById('other-sex-container').style.display = e.target.value === 'Other' ? 'block' : 'none';
        });

        // --- START THE APP ---
        initialize();
    });
    </script>
</body>
</html>

